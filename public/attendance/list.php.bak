<?php
require_once '../includes/header.php';

$pdo = get_pdo_connection();

// Add JavaScript for dynamic subject loading in filters
?>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const courseSelect = document.getElementById('filter_course_id                <form method="GET" action="list.php" class="mb-4" id="attendance_filter_form">
                    <div class="card bg-light border-0 mb-4">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-3 text-primary">
                                <i class="fas fa-filter"></i> Filter Attendance Records   const subjectSelect = document.getElementById('filter_subject_id');
    
    function loadSubjects(courseId) {
        if (!courseId) {
            subjectSelect.innerHTML = '<option value="">All Subjects</option>';
            return;
        }

        fetch('get_subjects.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'course_id=' + encodeURIComponent(courseId)
        })
        .then(response => response.json())
        .then(data => {
            subjectSelect.innerHTML = '<option value="">All Subjects</option>';
            
            if (data.error) {
                console.error('Error:', data.error);
                return;
            }

            data.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                if (subject.id == '<?php echo $filter_subject_id; ?>') {
                    option.selected = true;
                }
                subjectSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            subjectSelect.innerHTML = '<option value="">Error loading subjects</option>';
        });
    }

    if (courseSelect) {
        courseSelect.addEventListener('change', function() {
            loadSubjects(this.value);
        });

        // Load subjects if course is already selected
        if (courseSelect.value) {
            loadSubjects(courseSelect.value);
        }
    }
});
</script>
<?php

$courses = [];
$subjects = [];
$students_list = []; // For the filter dropdown
$attendance_records = [];
$total_records = 0;
$records_per_page = 10;
$current_page = isset($_GET['page']) ? (int)$_GET['page'] : 1;
$offset = ($current_page - 1) * $records_per_page;

// Filter parameters
$filter_start_date = $_GET['start_date'] ?? '';
$filter_end_date = $_GET['end_date'] ?? '';
$filter_course_id = $_GET['course_id'] ?? '';
$filter_subject_id = $_GET['subject_id'] ?? '';
$filter_student_id = $_GET['student_id'] ?? '';
$search_query = $_GET['search'] ?? '';

// Fetch courses for filter
try {
    $stmt = $pdo->query("SELECT id, name FROM courses ORDER BY name");
    $courses = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    error_log("Error fetching courses: " . $e->getMessage());
}

// Fetch students for filter (Admin/Teacher only)
if (has_role('admin') || has_role('teacher')) {
    try {
        $stmt = $pdo->query("SELECT id, first_name, last_name FROM students ORDER BY last_name, first_name");
        $students_list = $stmt->fetchAll(PDO::FETCH_ASSOC);
    } catch (PDOException $e) {
        error_log("Error fetching students for filter: " . $e->getMessage());
    }
}

// Build query for attendance records
$sql = "SELECT
            a.id as attendance_id,
            a.date,
            a.status,
            s.id as student_id,
            s.first_name as student_first_name,
            s.last_name as student_last_name,
            sub.name as subject_name,
            c.name as course_name,
            u.first_name as marked_by_first_name,
            u.last_name as marked_by_last_name
        FROM
            attendance a
        JOIN
            students s ON a.student_id = s.id
        JOIN
            subjects sub ON a.subject_id = sub.id
        JOIN
            courses c ON sub.course_id = c.id
        JOIN
            users u ON a.marked_by = u.id
        WHERE 1=1";

$count_sql = "SELECT COUNT(*) FROM attendance a
              JOIN students s ON a.student_id = s.id
              JOIN subjects sub ON a.subject_id = sub.id
              JOIN courses c ON sub.course_id = c.id
              JOIN users u ON a.marked_by = u.id
              WHERE 1=1";

$params = [];

// Apply filters
if ($filter_start_date && isValidDate($filter_start_date)) {
    $sql .= " AND a.date >= ?";
    $count_sql .= " AND a.date >= ?";
    $params[] = $filter_start_date;
}
if ($filter_end_date && isValidDate($filter_end_date)) {
    $sql .= " AND a.date <= ?";
    $count_sql .= " AND a.date <= ?";
    $params[] = $filter_end_date;
}
if ($filter_course_id) {
    $sql .= " AND c.id = ?";
    $count_sql .= " AND c.id = ?";
    $params[] = $filter_course_id;
}
if ($filter_subject_id) {
    $sql .= " AND sub.id = ?";
    $count_sql .= " AND sub.id = ?";
    $params[] = $filter_subject_id;
}

// Role-based access control for viewing records
if (has_role('student')) {
    // Students can only see their own records
    $stmt_student_id = $pdo->prepare("SELECT id FROM students WHERE user_id = ?");
    $stmt_student_id->execute([$user_id]);
    $current_student_id = $stmt_student_id->fetchColumn();
    if ($current_student_id) {
        $sql .= " AND s.id = ?";
        $count_sql .= " AND s.id = ?";
        $params[] = $current_student_id;
    } else {
        // If student user_id doesn't map to a student record, show nothing
        $sql .= " AND 0=1";
        $count_sql .= " AND 0=1";
    }
} elseif (has_role('parent')) {
    // Parents can only see their children's records
    $stmt_children_ids = $pdo->prepare("SELECT id FROM students WHERE parent_user_id = ?"); // Assuming a parent_user_id column in students table
    $stmt_children_ids->execute([$user_id]);
    $children_ids = $stmt_children_ids->fetchAll(PDO::FETCH_COLUMN);
    if (!empty($children_ids)) {
        $placeholders = implode(',', array_fill(0, count($children_ids), '?'));
        $sql .= " AND s.id IN ($placeholders)";
        $count_sql .= " AND s.id IN ($placeholders)";
        $params = array_merge($params, $children_ids);
    } else {
        $sql .= " AND 0=1";
        $count_sql .= " AND 0=1";
    }
} else { // Admin or Teacher
    if ($filter_student_id) {
        $sql .= " AND s.id = ?";
        $count_sql .= " AND s.id = ?";
        $params[] = $filter_student_id;
    }
}

// Search query (student name, subject name, course name)
if ($search_query) {
    $search_term = '%' . $search_query . '%';
    $sql .= " AND (s.first_name LIKE ? OR s.last_name LIKE ? OR sub.name LIKE ? OR c.name LIKE ?)";
    $count_sql .= " AND (s.first_name LIKE ? OR s.last_name LIKE ? OR sub.name LIKE ? OR c.name LIKE ?)";
    $params[] = $search_term;
    $params[] = $search_term;
    $params[] = $search_term;
    $params[] = $search_term;
}

// Get total records for pagination
try {
    error_log("Attendance Count SQL: " . $count_sql);
    error_log("Attendance Count Params: " . print_r($params, true));
    $stmt_count = $pdo->prepare($count_sql);
    $stmt_count->execute($params);
    $total_records = $stmt_count->fetchColumn();
} catch (PDOException $e) {
    error_log("Error counting attendance records: " . $e->getMessage());
}

$total_pages = ceil($total_records / $records_per_page);

$sql .= " ORDER BY a.date DESC, s.last_name ASC, s.first_name ASC LIMIT ? OFFSET ?";
$params[] = $records_per_page;
$params[] = $offset;

// Fetch attendance records
try {
    error_log("Attendance List SQL: " . $sql);
    error_log("Attendance List Params: " . print_r($params, true));
    $stmt = $pdo->prepare($sql);
    $stmt->execute($params);
    $attendance_records = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    error_log("Error fetching attendance records: " . $e->getMessage());
}

// Fetch subjects based on selected course for filter dropdown (if course is selected)
if ($filter_course_id) {
    try {
        if (has_role('teacher')) {
            // Teachers see only subjects they are assigned to in that course
            $stmt_subjects = $pdo->prepare("SELECT id, name FROM subjects WHERE course_id = ? AND teacher_id = (SELECT id FROM users WHERE id = ?)");
            $stmt_subjects->execute([$filter_course_id, $user_id]);
        } else {
            // Admins see all subjects in that course
            $stmt_subjects = $pdo->prepare("SELECT id, name FROM subjects WHERE course_id = ? ORDER BY name");
            $stmt_subjects->execute([$filter_course_id]);
        }
        $subjects = $stmt_subjects->fetchAll(PDO::FETCH_ASSOC);
    } catch (PDOException $e) {
        error_log("Error fetching subjects for filter: " . $e->getMessage());
    }
}

?>


    <div class="container-fluid px-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h5 class="m-0">
                    <i class="fas fa-calendar-check me-2"></i>Attendance Records
                </h5>
                <?php if (has_role('admin') || has_role('teacher')): ?>
                <div>
                    <a href="mark.php" class="btn btn-primary">
                        <i class="fas fa-plus-circle me-2"></i>Mark New Attendance
                    </a>
                    <a href="report.php" class="btn btn-light ms-2">
                        <i class="fas fa-file-alt me-2"></i>Generate Report
                    </a>
                </div>
                <?php endif; ?>
            </div>
            <div class="card-body">
                <!-- Filters -->
                <form method="GET" action="list.php" class="mb-4">
                    <div class="card bg-light border-0 mb-4">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-3 text-primary">
                                <i class="fas fa-filter me-2"></i>Filter Records
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label for="start_date" class="form-label">Start Date</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="fas fa-calendar"></i>
                                        </span>
                                        <input type="date" class="form-control" id="start_date" name="start_date" 
                                               value="<?php echo htmlspecialchars($filter_start_date); ?>">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="end_date" class="form-label">End Date</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="fas fa-calendar"></i>
                                        </span>
                                        <input type="date" class="form-control" id="end_date" name="end_date" 
                                               value="<?php echo htmlspecialchars($filter_end_date); ?>">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="course_id" class="form-label">Course</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="fas fa-graduation-cap"></i>
                                        </span>
                                        <select class="form-select" id="course_id" name="course_id">
                                            <option value="">All Courses</option>
                                            <?php foreach ($courses as $course): ?>
                                                <option value="<?php echo htmlspecialchars($course['id']); ?>" <?php echo ($filter_course_id == $course['id']) ? 'selected' : ''; ?>>
                                                    <?php echo htmlspecialchars($course['name']); ?>
                                                </option>
                                            <?php endforeach; ?>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="subject_id" class="form-label">Subject</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="fas fa-book"></i>
                                        </span>
                                        <select class="form-select" id="subject_id" name="subject_id">
                                            <option value="">All Subjects</option>
                                            <?php foreach ($subjects as $subject): ?>
                                                <option value="<?php echo htmlspecialchars($subject['id']); ?>" <?php echo ($filter_subject_id == $subject['id']) ? 'selected' : ''; ?>>
                                                    <?php echo htmlspecialchars($subject['name']); ?>
                                                </option>
                                            <?php endforeach; ?>
                                        </select>
                                    </div>
                                </div>
                                <?php if (has_role('admin') || has_role('teacher')): ?>
                                <div class="col-md-3">
                                    <label for="student_id" class="form-label">Student</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="fas fa-user-graduate"></i>
                                        </span>
                                        <select class="form-select" id="student_id" name="student_id">
                                            <option value="">All Students</option>
                                            <?php foreach ($students_list as $student): ?>
                                                <option value="<?php echo htmlspecialchars($student['id']); ?>" <?php echo ($filter_student_id == $student['id']) ? 'selected' : ''; ?>>
                                                    <?php echo htmlspecialchars($student['first_name'] . ' ' . $student['last_name']); ?>
                                                </option>
                                            <?php endforeach; ?>
                                        </select>
                                    </div>
                                </div>
                                <?php endif; ?>
                                <div class="col-md-3">
                                    <label for="search" class="form-label">Search</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" class="form-control" id="search" name="search" 
                                               value="<?php echo htmlspecialchars($search_query); ?>" 
                                               placeholder="Student/Subject/Course Name">
                                    </div>
                                </div>
                                <div class="col-md-12 mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-filter me-2"></i>Apply Filters
                                    </button>
                                    <a href="list.php" class="btn btn-light ms-2">
                                        <i class="fas fa-times me-2"></i>Clear Filters
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <?php if (empty($attendance_records)): ?>
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <div>No attendance records found matching your criteria.</div>
                    </div>
                <?php else: ?>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="py-3">Student Name</th>
                                    <th class="py-3">Subject</th>
                                    <th class="py-3">Course</th>
                                    <th class="py-3">Date</th>
                                    <th class="py-3">Status</th>
                                    <th class="py-3">Marked By</th>
                                    <?php if (has_role('admin') || has_role('teacher')): ?>
                                    <th class="py-3">Actions</th>
                                    <?php endif; ?>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($attendance_records as $record): ?>
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-user-graduate text-primary me-2"></i>
                                                <?php echo htmlspecialchars($record['student_first_name'] . ' ' . $record['student_last_name']); ?>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-book me-1"></i>
                                                <?php echo htmlspecialchars($record['subject_name']); ?>
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-graduation-cap me-1"></i>
                                                <?php echo htmlspecialchars($record['course_name']); ?>
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-calendar-alt text-muted me-2"></i>
                                                <?php echo htmlspecialchars($record['date']); ?>
                                            </div>
                                        </td>
                                        <td>
                                            <?php
                                            $status_class = '';
                                            $status_icon = '';
                                            switch(strtolower($record['status'])) {
                                                case 'present':
                                                    $status_class = 'bg-success';
                                                    $status_icon = 'fa-check-circle';
                                                    break;
                                                case 'absent':
                                                    $status_class = 'bg-danger';
                                                    $status_icon = 'fa-times-circle';
                                                    break;
                                                case 'late':
                                                    $status_class = 'bg-warning';
                                                    $status_icon = 'fa-clock';
                                                    break;
                                                default:
                                                    $status_class = 'bg-secondary';
                                                    $status_icon = 'fa-question-circle';
                                            }
                                            ?>
                                            <span class="badge <?php echo $status_class; ?>">
                                                <i class="fas <?php echo $status_icon; ?> me-1"></i>
                                                <?php echo htmlspecialchars(ucfirst($record['status'])); ?>
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-user text-muted me-2"></i>
                                                <?php echo htmlspecialchars($record['marked_by_first_name'] . ' ' . $record['marked_by_last_name']); ?>
                                            </div>
                                        </td>
                                        <?php if (has_role('admin') || has_role('teacher')): ?>
                                        <td>
                                            <div class="btn-group">
                                                <a href="mark.php?id=<?php echo htmlspecialchars($record['attendance_id']); ?>" class="btn btn-sm btn-light">
                                                    <i class="fas fa-edit me-1"></i> Edit
                                                </a>
                                                <a href="delete.php?id=<?php echo htmlspecialchars($record['attendance_id']); ?>" 
                                                   class="btn btn-sm btn-light text-danger"
                                                   onclick="return confirm('Are you sure you want to delete this record?');">
                                                    <i class="fas fa-trash-alt me-1"></i> Delete
                                                </a>
                                            </div>
                                        </td>
                                        <?php endif; ?>
                                    </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="mt-4">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center">
                                <?php if ($current_page > 1): ?>
                                    <li class="page-item">
                                        <a class="page-link" href="?<?php echo http_build_query(array_merge($_GET, ['page' => $current_page - 1])); ?>">
                                            <i class="fas fa-chevron-left small"></i>
                                        </a>
                                    </li>
                                <?php endif; ?>
                                
                                <?php for ($i = 1; $i <= $total_pages; $i++): ?>
                                    <li class="page-item <?php echo ($i == $current_page) ? 'active' : ''; ?>">
                                        <a class="page-link" href="?<?php echo http_build_query(array_merge($_GET, ['page' => $i])); ?>">
                                            <?php echo $i; ?>
                                        </a>
                                    </li>
                                <?php endfor; ?>
                                
                                <?php if ($current_page < $total_pages): ?>
                                    <li class="page-item">
                                        <a class="page-link" href="?<?php echo http_build_query(array_merge($_GET, ['page' => $current_page + 1])); ?>">
                                            <i class="fas fa-chevron-right small"></i>
                                        </a>
                                    </li>
                                <?php endif; ?>
                            </ul>
                        </nav>
                        <div class="text-center text-muted small mt-2">
                            Showing page <?php echo $current_page; ?> of <?php echo $total_pages; ?>
                        </div>
                    </div>
                <?php endif; ?>
            </div>
        </div>
    </div>
    </div>

    
